name: Build and Deploy to GitHub Pages

on:
  # Trigger on every push to main branch
  push:
    branches:
      - main

  # Trigger after the data update workflow completes
  workflow_run:
    workflows: ["Update Electricity Plans Data"]
    types:
      - completed
    branches:
      - main

  # Allow manual deployment
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Build and optimization job
  build:
    runs-on: ubuntu-latest
    # Only run if workflow_run was successful, or if triggered by push/workflow_dispatch
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name != 'workflow_run' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # Use the commit SHA from workflow_run event when triggered by another workflow
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Setup Pages
        uses: actions/configure-pages@v5
        with:
          # Enable Pages if not already enabled (requires appropriate permissions)
          enablement: true

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: bun install

      - name: Build project
        run: bun run build

      - name: Install minification tools
        run: |
          # Install Node.js minifiers using Bun
          bun add -g html-minifier-terser csso-cli terser
          # Install Python minifier
          pip install python-minifier

      - name: Create build directory structure
        run: |
          mkdir -p _site/assets/fonts/new_york/WOFF2
          mkdir -p _site/assets/fonts/san_francisco/WOFF2
          mkdir -p _site/css/modules
          mkdir -p _site/js/modules
          mkdir -p _site/data
          mkdir -p _site/scripts

      - name: Minify HTML files
        run: |
          find src -name "*.html" | while read -r file; do
            target="_site/${file#src/}"
            mkdir -p "$(dirname "$target")"
            html-minifier-terser \
              --collapse-whitespace \
              --remove-comments \
              --remove-redundant-attributes \
              --remove-script-type-attributes \
              --remove-style-link-type-attributes \
              --minify-css true \
              --minify-js true \
              --use-short-doctype \
              "$file" -o "$target"
            echo "✓ Minified: $file → $target"
          done

      - name: Minify CSS files
        run: |
          find src/css -name "*.css" | while read -r file; do
            target="_site/css/${file#src/css/}"
            mkdir -p "$(dirname "$target")"
            csso "$file" --output "$target" --comments none
            echo "✓ Minified: $file → $target"
          done

      - name: Minify TypeScript files
        run: |
          find src/js -name "*.js" | while read -r file; do
            target="_site/js/${file#src/js/}"
            mkdir -p "$(dirname "$target")"
            terser "$file" \
              --compress passes=2 \
              --mangle \
              --comments false \
              --output "$target"
            echo "✓ Minified: $file → $target"
          done

      - name: Minify Python scripts
        run: |
          find scripts -name "*.py" | while read -r file; do
            target="_site/scripts/${file#scripts/}"
            mkdir -p "$(dirname "$target")"
            pyminify \
              --remove-literal-statements \
              --remove-asserts \
              --hoist-literals \
              --rename-globals \
              --rename-locals \
              "$file" > "$target" || cp "$file" "$target"
            echo "✓ Processed: $file → $target"
          done

      - name: Copy optimized fonts (WOFF2 only)
        run: |
          # Only copy WOFF2 format for optimal compression
          if [ -d "src/assets/fonts/new_york/WOFF2" ]; then
            cp -r src/assets/fonts/new_york/WOFF2/* _site/assets/fonts/new_york/WOFF2/
            echo "✓ Copied New York fonts (WOFF2)"
          fi
          if [ -d "src/assets/fonts/san_francisco/WOFF2" ]; then
            cp -r src/assets/fonts/san_francisco/WOFF2/* _site/assets/fonts/san_francisco/WOFF2/
            echo "✓ Copied San Francisco fonts (WOFF2)"
          fi

      - name: Copy data files
        run: |
          # Copy all JSON data files (no minification to preserve data integrity)
          cp -r data/* _site/data/
          echo "✓ Copied data files"

      - name: Copy additional files
        run: |
          # Copy LICENSE and README for transparency
          cp LICENSE _site/ 2>/dev/null || true
          cp README.md _site/ 2>/dev/null || true
          echo "✓ Copied documentation files"

      - name: Create .nojekyll file
        run: |
          # Disable Jekyll processing
          touch _site/.nojekyll
          echo "✓ Created .nojekyll"

      - name: Generate build report
        run: |
          {
            echo "## Build Report"
            echo "### File Sizes"
            echo "\`\`\`"
            du -sh _site/* 2>/dev/null | sort -h
            echo "\`\`\`"
            echo "**Total size:** $(du -sh _site | cut -f1)"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'

  # Deployment job
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Create deployment summary
        run: |
          {
            echo "## Deployment Summary"
            echo "**Status:** Successfully deployed to GitHub Pages"
            echo "**URL:** ${{ steps.deployment.outputs.page_url }}"
            echo "**Date:** $(date +'%Y-%m-%d %H:%M:%S UTC')"
            echo ""
            echo "### Optimizations Applied"
            echo "- ✓ HTML minified (comments removed, whitespace collapsed)"
            echo "- ✓ CSS minified (CSSO with comment removal)"
            echo "- ✓ TypeScript minified (Terser with compression and mangling)"
            echo "- ✓ Python scripts minified (docstrings and comments removed)"
            echo "- ✓ Fonts optimized (WOFF2 only)"
          } >> "$GITHUB_STEP_SUMMARY"
