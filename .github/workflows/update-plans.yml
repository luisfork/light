name: Update Electricity Plans Data

on:
  # Run daily at 2 AM Central Time (8 AM UTC during DST, 7 AM UTC otherwise)
  schedule:
    - cron: '0 7 * * *'  # 7 AM UTC = ~2 AM Central

  # Allow manual triggering
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-data:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Install dependencies
        run: uv pip install --system requests beautifulsoup4 lxml

      - name: Create json-archive data directories
        run: |
          mkdir -p data/json-archive
          mkdir -p data/csv-archive

      - name: Archive current data before fetch
        run: |
          TIMESTAMP=$(date +'%Y-%m-%d')

          # Archive JSON
          if [ -f data/plans.json ]; then
            cp data/plans.json "data/json-archive/plans_${TIMESTAMP}.json"
            echo "Archived current plans to data/json-archive/plans_${TIMESTAMP}.json"
          fi

          # Archive CSV
          if [ -f data/plans.json ]; then
            export TIMESTAMP="${TIMESTAMP}"
            python scripts/archive_to_csv.py
          fi

      - name: Verify archive integrity
        run: |
          TIMESTAMP=$(date +'%Y-%m-%d')

          # Check JSON is valid
          if [ -f "data/json-archive/plans_${TIMESTAMP}.json" ]; then
            python -c "import json; json.load(open('data/json-archive/plans_${TIMESTAMP}.json'))"
            echo "✓ JSON archive is valid"
          fi

          # Check CSV has content
          if [ -f "data/csv-archive/plans_${TIMESTAMP}.csv" ]; then
            LINE_COUNT=$(wc -l < "data/csv-archive/plans_${TIMESTAMP}.csv")
            if [ $LINE_COUNT -gt 1 ]; then
              echo "✓ CSV archive has $LINE_COUNT lines"
            else
              echo "✗ CSV archive is empty"
              exit 1
            fi
          fi

      - name: Fetch electricity plans
        id: fetch_plans
        run: |
          python scripts/fetch_plans.py
        continue-on-error: true

      - name: Generate sample data if fetch failed
        if: steps.fetch_plans.outcome == 'failure'
        run: |
          echo "Plan fetch failed, generating sample data..."
          python scripts/generate_sample_data.py

      - name: Check for changes
        id: check_changes
        run: |
          # Check for changes in data directory (JSON or CSV)
          if [ -n "$(git status --porcelain data/)" ]; then
            echo "changes=true" >> $GITHUB_OUTPUT
          else
            echo "changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Verify json-archive data directory
        run: |
          echo "Historical plan data archive maintained indefinitely for trend analysis"
          ls -lh data/json-archive/ || echo "No json-archive files yet"

      - name: Commit and push changes
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/plans.json data/json-archive/ data/csv-archive/
          git commit -m "Update electricity plans data - $(date +'%Y-%m-%d')"
          git pull --rebase --autostash
          git push

      - name: Create summary
        run: |
          echo "## Data Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check_changes.outputs.changes }}" == "true" ]; then
            echo "**Status:** ✅ Data updated successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** ℹ️ No changes detected" >> $GITHUB_STEP_SUMMARY
          fi

          # Count plans in the file
          PLAN_COUNT=$(python -c "import json; data = json.load(open('data/plans.json')); print(data['total_plans'])")
          echo "**Total Plans:** $PLAN_COUNT" >> $GITHUB_STEP_SUMMARY
