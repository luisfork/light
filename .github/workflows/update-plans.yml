name: Update Electricity Plans Data

on:
  # Run daily at 2 AM Central Time (8 AM UTC during DST, 7 AM UTC otherwise)
  schedule:
    - cron: '0 7 * * *'  # 7 AM UTC = ~2 AM Central

  # Allow manual triggering
  workflow_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Install dependencies
        run: uv pip install --system requests beautifulsoup4 lxml

      - name: Create historical data directories
        run: |
          mkdir -p data/historical
          mkdir -p data/archive-csv

      - name: Archive current data before fetch
        run: |
          TIMESTAMP=$(date +'%Y-%m-%d')

          # Archive JSON
          if [ -f data/plans.json ]; then
            cp data/plans.json "data/historical/plans_${TIMESTAMP}.json"
            echo "Archived current plans to data/historical/plans_${TIMESTAMP}.json"
          fi

          # Archive CSV
          if [ -f data/plans.json ]; then
            python3 << 'PYTHON_SCRIPT'
import json
import csv
import os
from datetime import datetime

with open('data/plans.json', 'r') as f:
    data = json.load(f)

plans = data.get('plans', [])
if plans:
    columns = [
        'plan_id', 'plan_name', 'rep_name', 'tdu_area', 'rate_type',
        'term_months', 'price_kwh_500', 'price_kwh_1000', 'price_kwh_2000',
        'base_charge_monthly', 'early_termination_fee', 'renewable_pct',
        'is_prepaid', 'is_tou', 'special_terms', 'efl_url', 'enrollment_url'
    ]
    timestamp = os.environ.get('TIMESTAMP', datetime.now().strftime('%Y%m%d_%H%M%S'))
    os.makedirs('data/archive-csv', exist_ok=True)
    with open(f'data/archive-csv/plans_{timestamp}.csv', 'w', newline='', encoding='utf-8') as csvfile:
        writer = csv.DictWriter(csvfile, fieldnames=columns, extrasaction='ignore')
        writer.writeheader()
        for plan in plans:
            writer.writerow(plan)
    print(f'Archived {len(plans)} plans to data/archive-csv/plans_{timestamp}.csv')
PYTHON_SCRIPT
          fi

      - name: Fetch electricity plans
        id: fetch_plans
        run: |
          python scripts/fetch_plans.py
        continue-on-error: true

      - name: Generate sample data if fetch failed
        if: steps.fetch_plans.outcome == 'failure'
        run: |
          echo "Plan fetch failed, generating sample data..."
          python scripts/generate_sample_data.py

      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet data/plans.json; then
            echo "changes=false" >> $GITHUB_OUTPUT
          else
            echo "changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Verify historical data directory
        run: |
          echo "Historical plan data archive maintained indefinitely for trend analysis"
          ls -lh data/historical/ || echo "No historical files yet"

      - name: Commit and push changes
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/plans.json data/historical/ data/archive-csv/
          git commit -m "Update electricity plans data - $(date +'%Y-%m-%d')"
          git push

      - name: Create summary
        run: |
          echo "## Data Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check_changes.outputs.changes }}" == "true" ]; then
            echo "**Status:** ✅ Data updated successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** ℹ️ No changes detected" >> $GITHUB_STEP_SUMMARY
          fi

          # Count plans in the file
          PLAN_COUNT=$(python -c "import json; data = json.load(open('data/plans.json')); print(data['total_plans'])")
          echo "**Total Plans:** $PLAN_COUNT" >> $GITHUB_STEP_SUMMARY
