name: Lint Code

on:
  push:
    branches:
      - main
      - 'claude/**'
      - 'copilot/**'
  pull_request:
    branches:
      - main

permissions:
  contents: read

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Cache npm global packages
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-lint-${{ hashFiles('.github/workflows/lint.yml') }}
          restore-keys: |
            ${{ runner.os }}-npm-lint-

      - name: Install Python linters (ruff, djlint)
        run: |
          uv tool install ruff
          uv tool install djlint

      - name: Install TypeScript tools
        run: npm install -g @biomejs/biome@1.9.4

      - name: Run Ruff (Python)
        id: ruff
        continue-on-error: true
        run: uv tool run ruff check scripts/

      - name: Run Biome (JS/JSON)
        id: biome
        continue-on-error: true
        run: biome check src/ --diagnostic-level=error

      - name: Run djlint (HTML)
        id: djlint
        continue-on-error: true
        run: uv tool run djlint src/ --check

      - name: Run actionlint (Workflows)
        id: actionlint
        continue-on-error: true
        uses: reviewdog/action-actionlint@v1
        with:
          fail_level: none

      - name: Create summary
        if: always()
        run: |
          {
            echo "## Linting Summary"
            echo ""
            echo "| Tool | Status |"
            echo "|------|--------|"
            echo "| ruff (Python) | ${{ steps.ruff.outcome == 'success' && '✓' || '✗' }} |"
            echo "| biome (JS/JSON) | ${{ steps.biome.outcome == 'success' && '✓' || '✗' }} |"
            echo "| djlint (HTML) | ${{ steps.djlint.outcome == 'success' && '✓' || '✗' }} |"
            echo "| actionlint (Workflows) | ${{ steps.actionlint.outcome == 'success' && '✓' || '✗' }} |"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Check linting results
        if: always()
        run: |
          if [[ "${{ steps.ruff.outcome }}" == "failure" ]] || \
             [[ "${{ steps.djlint.outcome }}" == "failure" ]] || \
             [[ "${{ steps.actionlint.outcome }}" == "failure" ]]; then
            echo "✗ Some linting checks failed"
            exit 1
          else
            echo "✓ All linting checks passed"
            # Note: Biome warnings are informational only
            if [[ "${{ steps.biome.outcome }}" == "failure" ]]; then
              echo "ℹ️ Biome reported style warnings (non-blocking)"
            fi
          fi